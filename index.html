<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pusat Link Favorit</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
<style>
  :root{
    --bg:#000; --panel:#111; --muted:#b7c1d6; --card-bg: rgba(255,255,255,0.04);
    --accent:#4d90fe; --highlight:#ffd94d;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:#e6eef8;background:var(--bg);display:flex;flex-direction:column;}
  .header{display:flex;align-items:center;gap:8px;padding:10px;background:var(--panel);border-bottom:1px solid #222;flex-wrap:wrap;position:relative}
  .header h1{margin:0;flex:1;font-size:1.4rem}
  .controls{display:flex;gap:6px;align-items:center}
  .controls input,.controls button,.controls select{padding:7px 10px;border-radius:8px;border:none;background:#222;color:#fff;font-size:0.95rem;cursor:pointer;outline:none}
  .controls button i{margin-right:6px}
  .container{padding:12px;display:grid;gap:8px;flex:1;overflow:auto}
  .group-container{margin-bottom:6px;padding-bottom:6px}
  .group-title{font-size:1.12rem;font-weight:700;margin:6px 0 6px;border-bottom:1px solid #2b2f44;padding-bottom:6px}
  .grid-view .group-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
  .card-view .group-items{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
  .list-view .group-items{display:flex;flex-direction:column;gap:8px}
  .link-card{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:var(--card-bg);box-shadow:0 6px 18px rgba(2,6,23,0.45);cursor:pointer;transition:transform .12s,box-shadow .12s}
  .link-card:hover{transform:translateY(-3px);box-shadow:0 10px 28px rgba(2,6,23,0.6)}
  .link-info{display:flex;align-items:center;gap:12px;flex:1}
  .link-icon{width:44px;height:44px;min-width:44px;border-radius:8px;display:grid;place-items:center;font-size:1.25rem;color:var(--muted);background:rgba(255,255,255,0.02);object-fit:cover}
  .link-title{font-weight:600;margin:0}
  .link-actions{display:flex;gap:8px;align-items:center;margin-left:12px}
  .btn-icon{background:none;border:none;color:var(--muted);font-size:1.05rem;cursor:pointer}
  .btn-icon:hover{color:#fff;transform:scale(1.12)}
  .favorite{color:#ffd700!important}
  .highlight{border:2px solid var(--accent);border-radius:10px}
  .preview-popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:1200}
  .preview-content{width:92%;max-width:900px;height:80%;background:var(--panel);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
  .preview-header{display:flex;justify-content:flex-end;gap:8px;padding:8px;background:#000}
  .preview-iframe{flex:1;border:none}
  .settings-menu{display:none;position:absolute;top:56px;right:10px;background:var(--panel);border:1px solid #222;border-radius:10px;padding:10px;z-index:1100;min-width:240px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  .settings-menu.open{display:flex;flex-direction:column;gap:8px}
  .settings-row{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .settings-row label{font-size:0.95rem}
  .tips-menu{display:none;position:absolute;top:56px;right:140px;background:var(--panel);border:1px solid #222;border-radius:10px;padding:10px;z-index:1100;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  .tips-menu.open{display:block}
  .reset-popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:1300}
  .reset-box{background:var(--panel);padding:18px;border-radius:10px;width:92%;max-width:420px;position:relative}
  .reset-close{position:absolute;right:10px;top:8px;background:none;border:none;color:#fff;font-size:1.1rem;cursor:pointer}
  .reset-instruction{margin:6px 0;font-size:0.98rem}
  .reset-instruction .stabilo{background:var(--highlight);color:#000;padding:0 6px;border-radius:4px;font-weight:700}
  .reset-input{width:100%;padding:10px;border-radius:8px;border:none;background:#222;color:#fff;text-transform:uppercase;text-align:center;font-size:1rem;outline:none}
  .confirm-popup{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(4px);justify-content:center;align-items:center;z-index:1400}
  .confirm-box{background:var(--panel);padding:18px;border-radius:10px;width:92%;max-width:420px;text-align:center}
  .btn-primary{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer}
  .btn-ghost{padding:8px 12px;border-radius:8px;border:1px solid #333;background:transparent;color:#fff;cursor:pointer}
  .btn-primary[disabled]{opacity:.6;cursor:not-allowed}
  .toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;font-size:0.95rem;opacity:0;transition:opacity .25s;z-index:1500}
  .toast.show{opacity:1}
  .original-link-small{padding:6px;text-align:center;font-size:0.85rem;color:#9aa6bf;background:transparent;border-top:1px solid rgba(255,255,255,0.02)}
  /* ensure bottom does not overlap controls */
  @media (max-width:760px){ .header h1{font-size:1.12rem} }
</style>
</head>
<body>
  <div class="header">
    <h1 id="header-title">Pusat Link Favorit</h1>
    <div class="controls">
      <input id="search-box" placeholder="">
      <button id="btn-settings" title=""><i class="fa-solid fa-gear"></i> <span id="btn-settings-label"></span></button>
      <button id="btn-tips" title=""><i class="fa-solid fa-lightbulb"></i> <span id="btn-tips-label"></span></button>

      <!-- settings -->
      <div class="settings-menu" id="settings-menu" aria-hidden="true">
        <div class="settings-row"><label id="lbl-language"></label><select id="sel-language"><option value="id">Indonesia</option><option value="en">English</option></select></div>
        <div class="settings-row"><label id="lbl-view"></label><select id="sel-view"><option value="list">List</option><option value="grid">Grid</option><option value="card">Card</option></select></div>
        <div class="settings-row"><label id="lbl-reset"></label><button id="btn-reset" class="btn-ghost"></button></div>
      </div>

      <!-- tips -->
      <div class="tips-menu" id="tips-menu" aria-hidden="true">
        <div id="tips-content"></div>
        <div style="height:8px"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="tips-reset-btn" class="btn-ghost"></button>
          <a id="original-link-bottom" href="#" target="_blank" class="btn-ghost" style="text-decoration:none"></a>
        </div>
      </div>

    </div>
  </div>

  <main class="container" id="link-container"></main>

  <!-- preview popup -->
  <div class="preview-popup" id="preview-popup">
    <div class="preview-content">
      <div class="preview-header">
        <button class="btn-icon" id="btn-go" title=""><i class="fa-solid fa-arrow-up-right-from-square"></i></button>
        <button class="btn-icon" id="btn-close" title=""><i class="fa-solid fa-xmark"></i></button>
      </div>
      <iframe id="preview-frame" class="preview-iframe" title="Pratinjau"></iframe>
    </div>
  </div>

  <!-- reset popup 1 -->
  <div class="reset-popup" id="reset-popup">
    <div class="reset-box">
      <button class="reset-close" id="reset-close">❌</button>
      <p class="reset-instruction" id="reset-instruction"></p>
      <input id="reset-input" class="reset-input" placeholder="" />
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="reset-cancel" class="btn-ghost"></button>
        <button id="reset-proceed" class="btn-primary"></button>
      </div>
    </div>
  </div>

  <!-- confirm popup 2 -->
  <div class="confirm-popup" id="confirm-popup">
    <div class="confirm-box">
      <p id="confirm-text"></p>
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button id="confirm-cancel" class="btn-ghost"></button>
        <button id="confirm-agree" class="btn-primary" disabled></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- small original link bottom (non-intrusive) -->
  <div class="original-link-small" id="original-link-small"><a id="original-link-anchor" href="#" target="_blank" style="color:var(--accent);text-decoration:underline"></a></div>

<script>
/* ======== Texts ======== */
const T = {
  id:{ title:"Pusat Link Favorit", settings:"Pengaturan", settings_title:"Pengaturan", lbl_language:"Bahasa", lbl_view:"Tampilan", lbl_reset:"Reset", reset_button:"Reset Data", reset_instruction:'Ketik <span class="stabilo">RESET</span> untuk menghapus semua data', reset_input_placeholder:"Ketik RESET untuk konfirmasi", reset_proceed:"Lanjut", reset_cancel:"Batal", confirm_text:"Yakin ingin menghapus semua data? Tindakan ini tidak bisa dibatalkan.", agree:"Setuju", cancel:"Batal", toast_loaded:"Data berhasil dimuat", toast_partial:"Beberapa data gagal dimuat", toast_failed:"Gagal memuat data, menampilkan favorit jika ada", footer_error:"Jika eror, coba reset (Pengaturan → Reset)", preview_open:"Buka Link", preview_close:"Tutup", original_link_text:"Original Link"}, 
  en:{ title:"Favorite Links Hub", settings:"Settings", settings_title:"Settings", lbl_language:"Language", lbl_view:"View", lbl_reset:"Reset", reset_button:"Reset Data", reset_instruction:'Type <span class="stabilo">RESET</span> to clear all data', reset_input_placeholder:"Type RESET to confirm", reset_proceed:"Proceed", reset_cancel:"Cancel", confirm_text:"Are you sure you want to clear all data? This action cannot be undone.", agree:"Agree", cancel:"Cancel", toast_loaded:"Data loaded successfully", toast_partial:"Some data failed to load", toast_failed:"Failed to load data, showing favorites if available", footer_error:"If error, try reset (Settings → Reset)", preview_open:"Open Link", preview_close:"Close", original_link_text:"Original Link"}
};

const ORIGINAL_LINK = "https://kuningminum.github.io/Kumin/Global%20Links.html";

/* ======== State ======== */
let favoriteLinks = JSON.parse(localStorage.getItem("favoriteLinks")||"[]");
let browserLang = (navigator.language && navigator.language.startsWith("id")) ? "id" : "en";
let currentLang = localStorage.getItem("lang") || browserLang;
let viewMode = localStorage.getItem("viewMode") || "list";
let linksData = [];
let lastErrorMessage = ""; // string shown only inside Tips when exists

/* ======== DOM ======== */
const headerTitle = document.getElementById("header-title");
const btnSettings = document.getElementById("btn-settings");
const btnSettingsLabel = document.getElementById("btn-settings-label");
const settingsMenu = document.getElementById("settings-menu");
const selLanguage = document.getElementById("sel-language");
const selView = document.getElementById("sel-view");
const btnReset = document.getElementById("btn-reset");

const btnTips = document.getElementById("btn-tips");
const tipsMenu = document.getElementById("tips-menu");
const tipsContent = document.getElementById("tips-content");
const tipsResetBtn = document.getElementById("tips-reset-btn");
const originalLinkBottom = document.getElementById("original-link-anchor");

const linkContainer = document.getElementById("link-container");
const previewPopup = document.getElementById("preview-popup");
const previewFrame = document.getElementById("preview-frame");
const btnGo = document.getElementById("btn-go");
const btnClose = document.getElementById("btn-close");
const toast = document.getElementById("toast");
const searchBox = document.getElementById("search-box");

/* reset UI */
const resetPopup = document.getElementById("reset-popup");
const resetInstruction = document.getElementById("reset-instruction");
const resetInput = document.getElementById("reset-input");
const resetCancel = document.getElementById("reset-cancel");
const resetProceed = document.getElementById("reset-proceed");
const resetClose = document.getElementById("reset-close");

const confirmPopup = document.getElementById("confirm-popup");
const confirmText = document.getElementById("confirm-text");
const confirmCancel = document.getElementById("confirm-cancel");
const confirmAgree = document.getElementById("confirm-agree");

/* ======== Helpers ======== */
function t(key){ return (T[currentLang] && T[currentLang][key]) || key; }
function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),3000); }

/* ======== UI apply language ======== */
function applyLanguageUI(){
  headerTitle.textContent = t("title");
  btnSettings.title = t("settings_title");
  btnSettingsLabel.textContent = t("settings");
  document.getElementById("lbl-language").textContent = t("lbl_language");
  document.getElementById("lbl-view").textContent = t("lbl_view");
  document.getElementById("lbl-reset").textContent = t("lbl_reset");
  document.getElementById("btn-reset").textContent = t("reset_button");
  resetInstruction.innerHTML = t("reset_instruction");
  resetInput.placeholder = t("reset_input_placeholder");
  resetProceed.textContent = t("reset_proceed");
  resetCancel.textContent = t("reset_cancel");
  confirmText.textContent = t("confirm_text");
  confirmCancel.textContent = t("cancel");
  confirmAgree.textContent = t("agree") + " (5)";
  btnGo.title = t("preview_open");
  btnClose.title = t("preview_close");
  document.getElementById("btn-tips-label").textContent = currentLang==="id" ? "Tips" : "Tips";
  tipsResetBtn.textContent = t("reset_button");
  originalLinkBottom.textContent = t("original_link_text");
  selLanguage.value = currentLang;
  selView.value = viewMode;
}
applyLanguageUI();

/* ======== Render links (compact spacing) ======== */
function renderLinks(list, search=""){
  linkContainer.innerHTML = "";
  const groups = {};
  list.forEach(l=>{
    const type = l.type || "local";
    const gid = l.grup_id || l.grup || "Tanpa Grup";
    const gen = l.grup_en || l.grup || "No Group";
    const key = type + "__" + gid;
    if(!groups[key]) groups[key] = {links:[], name:{id:gid,en:gen}, type};
    groups[key].links.push(l);
  });
  if(favoriteLinks.length) groups["FAVORIT"] = {links: favoriteLinks, name:{id:"Favorit",en:"Favorite"}, type:"favorite"};
  const keys = Object.keys(groups).sort((a,b)=> a==="FAVORIT"? -1 : b==="FAVORIT"? 1: 0);
  linkContainer.className = "container " + (viewMode==="grid"?"grid-view":viewMode==="card"?"card-view":"list-view");
  const q = (search||"").toLowerCase();
  keys.forEach(k=>{
    const g = groups[k];
    if(!g) return;
    const gc = document.createElement("section");
    gc.className = "group-container";
    const h = document.createElement("h2");
    h.className = "group-title";
    let gname = (currentLang==="id")?g.name.id:g.name.en;
    if(g.type==="local" && k!=="FAVORIT") gname += " (Lokal)";
    if(g.type==="global") gname += " (Global)";
    h.textContent = gname;
    gc.appendChild(h);
    const items = document.createElement("div"); items.className = "group-items";
    g.links.forEach(link=>{
      const titleText = (currentLang==="id")?link.title_id:(link.title_en||link.title_id);
      if(q && !(titleText.toLowerCase().includes(q) || (link.grup_id||"").toLowerCase().includes(q) || (link.grup_en||"").toLowerCase().includes(q))) return;
      const card = document.createElement("div"); card.className="link-card";
      const info = document.createElement("div"); info.className="link-info";
      const icon = document.createElement("div"); icon.className="link-icon";
      if(link.img){ const img=document.createElement("img"); img.src=link.img; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; img.style.borderRadius="6px"; icon.appendChild(img);} else { icon.innerHTML = `<i class="${link.icon||'fa-solid fa-link'}"></i>`; }
      const title = document.createElement("div"); title.className="link-title"; title.textContent = titleText;
      info.appendChild(icon); info.appendChild(title);
      const acts = document.createElement("div"); acts.className="link-actions";
      const eye = document.createElement("button"); eye.className="btn-icon"; eye.innerHTML='<i class="fa-solid fa-eye"></i>'; eye.title=t("preview_open");
      eye.addEventListener("click",(e)=>{ e.stopPropagation(); openPreview(link.url); });
      const open = document.createElement("button"); open.className="btn-icon"; open.innerHTML='<i class="fa-solid fa-arrow-up-right-from-square"></i>'; open.title=(currentLang==="id"?"Buka Link":"Open Link");
      open.addEventListener("click",(e)=>{ e.stopPropagation(); window.open(link.url,"_blank");});
      const favBtn = document.createElement("button"); favBtn.className="btn-icon"; favBtn.innerHTML = '<i class="fa-solid fa-star"></i>';
      if(favoriteLinks.some(f=>f.url===link.url)) favBtn.classList.add("favorite");
      favBtn.addEventListener("click",(e)=>{ e.stopPropagation(); const found = favoriteLinks.find(f=>f.url===link.url); if(found){ favoriteLinks = favoriteLinks.filter(f=>f.url!==link.url); favBtn.classList.remove("favorite"); } else { favoriteLinks.push({...link}); favBtn.classList.add("favorite"); } localStorage.setItem("favoriteLinks", JSON.stringify(favoriteLinks)); renderLinks(linksData, searchBox.value); });
      acts.appendChild(eye); acts.appendChild(open); acts.appendChild(favBtn);
      card.appendChild(info); card.appendChild(acts);
      card.addEventListener("click", ()=> window.open(link.url,"_blank"));
      items.appendChild(card);
    });
    gc.appendChild(items);
    linkContainer.appendChild(gc);
  });
}

/* ======== Preview popup ======== */
function openPreview(url){ previewFrame.src = url; previewPopup.style.display = "flex"; btnGo.onclick = ()=> window.open(url,"_blank"); }
btnClose.addEventListener("click", ()=>{ previewPopup.style.display = "none"; previewFrame.src = ""; });

/* ======== Settings interactions ======== */
btnSettings.addEventListener("click", (e)=>{ settingsMenu.classList.toggle("open"); tipsMenu.classList.remove("open"); });
selLanguage.addEventListener("change", ()=>{ currentLang = selLanguage.value; localStorage.setItem("lang", currentLang); applyLanguageUI(); renderLinks(linksData, searchBox.value); });
selView.addEventListener("change", ()=>{ viewMode = selView.value; localStorage.setItem("viewMode", viewMode); renderLinks(linksData, searchBox.value); });
btnReset.addEventListener("click", ()=>{ settingsMenu.classList.remove("open"); openResetPopup(); });

/* ======== Tips interactions ======== */
btnTips.addEventListener("click", ()=>{ tipsMenu.classList.toggle("open"); settingsMenu.classList.remove("open"); updateTipsContent(); });
tipsResetBtn.addEventListener("click", ()=>{ tipsMenu.classList.remove("open"); openResetPopup(); });

function updateTipsContent(){
  // show lastErrorMessage if exists, else a small tip
  if(lastErrorMessage){
    tipsContent.innerHTML = `<strong>${currentLang==="id"?"Peringatan":"Warning"}:</strong> ${lastErrorMessage} <div style="height:6px"></div><small>${t("original_link_text")}: <a href="${ORIGINAL_LINK}" target="_blank" rel="noopener">${ORIGINAL_LINK}</a></small>`;
  } else {
    tipsContent.innerHTML = `<strong>${currentLang==="id"?"Tips":"Tip"}:</strong> ${currentLang==="id"?"Jika ada masalah muat data, buka Pengaturan lalu Reset.":"If data fails to load, open Settings then Reset."}`;
  }
  tipsResetBtn.textContent = t("reset_button");
  originalLinkBottom.textContent = t("original_link_text");
  originalLinkBottom.href = ORIGINAL_LINK;
}

/* ======== Reset flow ======== */
function openResetPopup(){ resetInput.value=""; resetPopup.style.display="flex"; }
resetClose.addEventListener("click", ()=> resetPopup.style.display = "none");
resetCancel.addEventListener("click", ()=> resetPopup.style.display = "none");
resetProceed.addEventListener("click", ()=>{
  const v = (resetInput.value||"").trim().toUpperCase();
  if(v === "RESET"){
    resetPopup.style.display = "none";
    openConfirmPopup();
  } else {
    resetInput.style.boxShadow = "0 0 0 6px rgba(255,217,77,0.25)";
    setTimeout(()=> resetInput.style.boxShadow = "none",900);
    showToast(t("reset_input_placeholder"));
  }
});

function openConfirmPopup(){
  confirmPopup.style.display = "flex";
  confirmAgree.disabled = true;
  let sec = 5;
  confirmAgree.textContent = `${t("agree")} (${sec})`;
  const timer = setInterval(()=>{
    sec--;
    if(sec>0) confirmAgree.textContent = `${t("agree")} (${sec})`;
    else { clearInterval(timer); confirmAgree.disabled = false; confirmAgree.textContent = t("agree"); }
  },1000);
  confirmCancel.onclick = ()=> { confirmPopup.style.display = "none"; };
  confirmAgree.onclick = ()=> {
    localStorage.clear();
    confirmPopup.style.display = "none";
    showToast(currentLang==="id"?"Menghapus data...":"Clearing data...");
    setTimeout(()=> location.reload(), 600);
  };
}

/* ======== Load links tolerant ======== */
async function loadLinks(){
  const all = [];
  let errorCount = 0;
  lastErrorMessage = "";
  try{
    const res = await fetch("links.json?_="+Date.now());
    const j = await res.json();
    if(j.links && Array.isArray(j.links)) all.push(...j.links.map(x=>({...x,type:"local"})));
  } catch(e){ console.warn("local fail",e); errorCount++; lastErrorMessage += (currentLang==="id"?"Gagal memuat data lokal. ":"Failed to load local data. "); }
  try{
    const res2 = await fetch("https://raw.githubusercontent.com/KuningMinum/Kumin/refs/heads/main/link_global.json");
    const j2 = await res2.json();
    if(j2.links && Array.isArray(j2.links)) all.push(...j2.links.map(x=>({...x,type:"global"})));
  } catch(e){ console.warn("global fail",e); errorCount++; lastErrorMessage += (currentLang==="id"?"Gagal memuat data global. ":"Failed to load global data. "); }

  if(all.length === 0 && favoriteLinks.length) all.push(...favoriteLinks);

  if(errorCount > 0){
    // keep message only for tips; show a small toast
    showToast(errorCount === 2 ? t("toast_failed") : t("toast_partial"));
  } else {
    showToast(t("toast_loaded"));
  }

  return all;
}

/* ======== Init ======== */
function init(){
  selLanguage.value = currentLang;
  selView.value = viewMode;
  applyLanguageUI();
  updateTipsContent();
  originalLinkBottom.href = ORIGINAL_LINK;
  document.getElementById("original-link-small").querySelector("#original-link-anchor").textContent = t("original_link_text");
  document.getElementById("original-link-anchor").href = ORIGINAL_LINK;

  loadLinks().then(d=>{
    linksData = d;
    renderLinks(linksData);
  }).catch(e=>{
    console.error(e);
    // still rely on lastErrorMessage and showToast
    showToast(t("toast_failed"));
  });
}
init();

/* ======== Search ======== */
searchBox.addEventListener("input", ()=> renderLinks(linksData, searchBox.value));

/* close menus when click outside */
document.addEventListener("click", (e)=>{
  if(!settingsMenu.contains(e.target) && !btnSettings.contains(e.target)) settingsMenu.classList.remove("open");
  if(!tipsMenu.contains(e.target) && !btnTips.contains(e.target)) tipsMenu.classList.remove("open");
});
</script>
</body>
</html>
